<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Detector autom√°tico de billetes con IA">
    <link rel="manifest" href="manifest.json">
    <title>Detector Billetes Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 15px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status {
            font-size: 14px;
            color: #888;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto 15px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.2);
            background: #000;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .total-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .total-display h2 {
            font-size: 48px;
            color: #000;
            font-weight: bold;
            margin: 0;
        }

        .desglose {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            min-height: 100px;
        }

        .desglose-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .desglose-item:last-child {
            border-bottom: none;
        }

        .historial {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .historial h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .historial-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-save {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #000;
        }

        .btn-clear {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: #fff;
        }

        .btn-start {
            background: linear-gradient(135deg, #00ccff, #0088ff);
            color: #fff;
            grid-column: 1 / -1;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        .install-prompt {
            background: linear-gradient(135deg, #00ccff, #0088ff);
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            text-align: center;
        }

        .install-prompt button {
            background: #fff;
            color: #0088ff;
            margin-top: 10px;
            padding: 10px 20px;
        }

        @media (max-width: 480px) {
            .total-display h2 {
                font-size: 36px;
            }
            
            button {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="install-prompt" id="installPrompt">
            <p>üì± ¬°Instala la app en tu dispositivo!</p>
            <button onclick="instalarApp()">INSTALAR AHORA</button>
        </div>

        <div class="header">
            <h1>üíµ Detector de Billetes Pro</h1>
            <div class="status" id="status">Presiona iniciar para comenzar</div>
        </div>

        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <div class="total-display">
            <h2 id="total">$0</h2>
        </div>

        <div class="desglose" id="desglose">
            <p style="text-align: center; color: #888;">Sin detecciones a√∫n</p>
        </div>

        <div class="historial">
            <h3>üìã Historial de Conteos</h3>
            <div id="historial-list"></div>
        </div>

        <div class="buttons">
            <button class="btn-start" id="btnStart" onclick="iniciarCamara()">
                üé• INICIAR C√ÅMARA
            </button>
            <button class="btn-save" onclick="guardarConteo()">üíæ GUARDAR</button>
            <button class="btn-clear" onclick="limpiarTodo()">üóëÔ∏è LIMPIAR</button>
        </div>
    </div>

    <!-- ONNX Runtime Web -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

    <script>
        // ========================================
        // CONFIGURACI√ìN
        // ========================================
        const VALORES = {
            "100": 100,
            "1000": 1000,
            "200": 200,
            "50": 50,
            "500": 500,
            "CIEN-MIL": 100000,
            "CINCO-MIL": 5000,
            "CINCUENTA-MIL": 50000,
            "DIEZ-MIL": 10000,
            "DOS-MIL": 2000,
            "VEINTE-MIL": 20000
        };

        const CLASS_NAMES = Object.keys(VALORES);
        const CONF_THRESHOLD = 0.5;
        const IOU_THRESHOLD = 0.6;
        const INPUT_SIZE = 640;

        // Variables globales
        let video, canvas, ctx;
        let stream = null;
        let deteccionesActuales = {};
        let totalActual = 0;
        let historial = [];
        let deteccionActiva = false;
        let session = null;
        let deferredPrompt = null;

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('‚úÖ Service Worker registrado'))
                .catch(err => console.log('‚ùå Error SW:', err));
        }

        // Prompt de instalaci√≥n PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        function instalarApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('‚úÖ App instalada');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                });
            }
        }

        // Cargar historial
        function cargarHistorial() {
            const saved = localStorage.getItem('historial_billetes');
            if (saved) {
                historial = JSON.parse(saved);
                actualizarHistorialUI();
            }
        }

        // Inicializar cuando cargue la p√°gina
        window.onload = async function() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            cargarHistorial();
            
            // Cargar modelo ONNX
            try {
                document.getElementById('status').textContent = 'Cargando modelo IA...';
                session = await ort.InferenceSession.create('models/best.onnx');
                document.getElementById('status').textContent = '‚úÖ Modelo cargado - Presiona iniciar';
                console.log('‚úÖ Modelo ONNX cargado exitosamente');
            } catch (error) {
                console.error('‚ùå Error cargando modelo:', error);
                document.getElementById('status').innerHTML = 
                    '<div class="error">‚ö†Ô∏è No se pudo cargar el modelo ONNX.<br>Verifica que "models/best.onnx" exista.</div>';
            }
        };

        // ========================================
        // C√ÅMARA
        // ========================================

        async function iniciarCamara() {
            if (!session) {
                alert('‚ö†Ô∏è El modelo ONNX no est√° cargado. No se puede iniciar la detecci√≥n.');
                return;
            }

            try {
                document.getElementById('status').textContent = 'Iniciando c√°mara...';
                document.getElementById('btnStart').disabled = true;

                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });

                video.srcObject = stream;
                
                video.onloadedmetadata = function() {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    document.getElementById('status').textContent = '‚úÖ C√°mara activa - Detectando...';
                    document.getElementById('btnStart').textContent = 'üõë DETENER';
                    document.getElementById('btnStart').onclick = detenerCamara;
                    document.getElementById('btnStart').disabled = false;
                    
                    deteccionActiva = true;
                    detectarConONNX();
                };

            } catch (error) {
                console.error('‚ùå Error accediendo a la c√°mara:', error);
                document.getElementById('status').innerHTML = 
                    '<div class="error">‚ùå No se pudo acceder a la c√°mara.<br>Verifica los permisos en Configuraci√≥n.</div>';
                document.getElementById('btnStart').disabled = false;
            }
        }

        function detenerCamara() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                deteccionActiva = false;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                document.getElementById('status').textContent = '‚è∏Ô∏è C√°mara detenida';
                document.getElementById('btnStart').textContent = 'üé• INICIAR C√ÅMARA';
                document.getElementById('btnStart').onclick = iniciarCamara;
            }
        }

        // ========================================
        // DETECCI√ìN CON ONNX (REAL)
        // ========================================

        async function detectarConONNX() {
            if (!deteccionActiva || !session) return;

            try {
                // Preprocesar imagen
                const input = preprocesarImagen();
                
                // Inferencia
                const feeds = {};
                feeds[session.inputNames[0]] = input;
                const results = await session.run(feeds);
                
                // Postprocesar
                const outputData = results[session.outputNames[0]].data;
                const detecciones = postprocesarResultados(outputData, canvas.width, canvas.height);
                
                // Aplicar NMS
                const deteccionesFiltradas = nonMaxSuppression(detecciones, IOU_THRESHOLD);
                
                // Actualizar contador
                deteccionesActuales = {};
                for (const det of deteccionesFiltradas) {
                    const clase = det.class;
                    deteccionesActuales[clase] = (deteccionesActuales[clase] || 0) + 1;
                }
                
                actualizarDisplay();
                dibujarDetecciones(deteccionesFiltradas);
                
            } catch (error) {
                console.error('‚ùå Error en detecci√≥n:', error);
            }

            // Continuar detectando
            setTimeout(detectarConONNX, 500);
        }

        function preprocesarImagen() {
            // Crear canvas temporal para redimensionar
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = INPUT_SIZE;
            tempCanvas.height = INPUT_SIZE;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Dibujar y redimensionar
            tempCtx.drawImage(video, 0, 0, INPUT_SIZE, INPUT_SIZE);
            const imageData = tempCtx.getImageData(0, 0, INPUT_SIZE, INPUT_SIZE);
            const { data } = imageData;
            
            // Convertir a Float32Array y normalizar [0-255] -> [0-1]
            const input = new Float32Array(1 * 3 * INPUT_SIZE * INPUT_SIZE);
            
            for (let i = 0; i < INPUT_SIZE * INPUT_SIZE; i++) {
                const pixelIndex = i * 4; // RGBA
                // RGB a CHW formato
                input[i] = data[pixelIndex] / 255.0;                                    // R
                input[INPUT_SIZE * INPUT_SIZE + i] = data[pixelIndex + 1] / 255.0;     // G
                input[INPUT_SIZE * INPUT_SIZE * 2 + i] = data[pixelIndex + 2] / 255.0; // B
            }
            
            return new ort.Tensor('float32', input, [1, 3, INPUT_SIZE, INPUT_SIZE]);
        }

        function postprocesarResultados(outputData, imgWidth, imgHeight) {
            const detecciones = [];
            const numClasses = CLASS_NAMES.length;
            const numBoxes = outputData.length / (numClasses + 4);
            
            for (let i = 0; i < numBoxes; i++) {
                // Extraer bbox: [x_center, y_center, width, height]
                const xCenter = outputData[i];
                const yCenter = outputData[numBoxes + i];
                const width = outputData[numBoxes * 2 + i];
                const height = outputData[numBoxes * 3 + i];
                
                // Encontrar clase con mayor score
                let maxScore = 0;
                let maxClassId = 0;
                
                for (let c = 0; c < numClasses; c++) {
                    const score = outputData[numBoxes * (4 + c) + i];
                    if (score > maxScore) {
                        maxScore = score;
                        maxClassId = c;
                    }
                }
                
                // Filtrar por confianza
                if (maxScore > CONF_THRESHOLD) {
                    // Convertir coordenadas a p√≠xeles
                    const x1 = Math.max(0, (xCenter - width / 2) * imgWidth / INPUT_SIZE);
                    const y1 = Math.max(0, (yCenter - height / 2) * imgHeight / INPUT_SIZE);
                    const x2 = Math.min(imgWidth, (xCenter + width / 2) * imgWidth / INPUT_SIZE);
                    const y2 = Math.min(imgHeight, (yCenter + height / 2) * imgHeight / INPUT_SIZE);
                    
                    detecciones.push({
                        class: CLASS_NAMES[maxClassId],
                        conf: maxScore,
                        bbox: [x1, y1, x2, y2]
                    });
                }
            }
            
            return detecciones;
        }

        function nonMaxSuppression(detecciones, iouThreshold) {
            detecciones.sort((a, b) => b.conf - a.conf);
            
            const resultado = [];
            const suppressed = new Array(detecciones.length).fill(false);
            
            for (let i = 0; i < detecciones.length; i++) {
                if (suppressed[i]) continue;
                
                resultado.push(detecciones[i]);
                
                for (let j = i + 1; j < detecciones.length; j++) {
                    if (suppressed[j]) continue;
                    
                    if (detecciones[i].class === detecciones[j].class) {
                        const iou = calcularIoU(detecciones[i].bbox, detecciones[j].bbox);
                        if (iou > iouThreshold) {
                            suppressed[j] = true;
                        }
                    }
                }
            }
            
            return resultado;
        }

        function calcularIoU(bbox1, bbox2) {
            const [x1_1, y1_1, x2_1, y2_1] = bbox1;
            const [x1_2, y1_2, x2_2, y2_2] = bbox2;
            
            const xi1 = Math.max(x1_1, x1_2);
            const yi1 = Math.max(y1_1, y1_2);
            const xi2 = Math.min(x2_1, x2_2);
            const yi2 = Math.min(y2_1, y2_2);
            
            const interArea = Math.max(0, xi2 - xi1) * Math.max(0, yi2 - yi1);
            const bbox1Area = (x2_1 - x1_1) * (y2_1 - y1_1);
            const bbox2Area = (x2_2 - x1_2) * (y2_2 - y1_2);
            const unionArea = bbox1Area + bbox2Area - interArea;
            
            return unionArea > 0 ? interArea / unionArea : 0;
        }

        function dibujarDetecciones(detecciones) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 3;
            ctx.font = 'bold 18px Arial';
            
            for (const det of detecciones) {
                const [x1, y1, x2, y2] = det.bbox;
                
                // Rect√°ngulo
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // Etiqueta con fondo
                const label = `${det.class} ${(det.conf * 100).toFixed(0)}%`;
                const textWidth = ctx.measureText(label).width;
                
                ctx.fillStyle = '#00ff88';
                ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
                
                ctx.fillStyle = '#000';
                ctx.fillText(label, x1 + 5, y1 - 5);
            }
        }

        // ========================================
        // DISPLAY Y UI
        // ========================================

        function actualizarDisplay() {
            totalActual = 0;
            for (let [billete, cantidad] of Object.entries(deteccionesActuales)) {
                totalActual += VALORES[billete] * cantidad;
            }

            document.getElementById('total').textContent = `$${totalActual.toLocaleString()}`;

            const desgloseDiv = document.getElementById('desglose');
            if (Object.keys(deteccionesActuales).length === 0) {
                desgloseDiv.innerHTML = '<p style="text-align: center; color: #888;">Sin detecciones a√∫n</p>';
            } else {
                let html = '';
                for (let [billete, cantidad] of Object.entries(deteccionesActuales)) {
                    const subtotal = VALORES[billete] * cantidad;
                    html += `
                        <div class="desglose-item">
                            <span>${cantidad}x ${billete}</span>
                            <span style="color: #00ff88; font-weight: bold;">$${subtotal.toLocaleString()}</span>
                        </div>
                    `;
                }
                desgloseDiv.innerHTML = html;
            }
        }

        function guardarConteo() {
            if (totalActual === 0) {
                alert('‚ö†Ô∏è No hay nada que guardar');
                return;
            }

            const timestamp = new Date().toLocaleString();
            const registro = {
                timestamp,
                total: totalActual,
                desglose: {...deteccionesActuales}
            };

            historial.unshift(registro);
            if (historial.length > 50) historial = historial.slice(0, 50);

            localStorage.setItem('historial_billetes', JSON.stringify(historial));
            actualizarHistorialUI();

            document.getElementById('status').textContent = '‚úÖ Conteo guardado';
            setTimeout(() => {
                if (deteccionActiva) {
                    document.getElementById('status').textContent = '‚úÖ C√°mara activa - Detectando...';
                }
            }, 2000);
        }

        function actualizarHistorialUI() {
            const historialList = document.getElementById('historial-list');
            
            if (historial.length === 0) {
                historialList.innerHTML = '<p style="text-align: center; color: #888;">Sin registros</p>';
                return;
            }

            let html = '';
            for (let registro of historial.slice(0, 10)) {
                const desglose = Object.entries(registro.desglose)
                    .map(([b, c]) => `${c}x${b}`)
                    .join(', ');
                
                html += `
                    <div class="historial-item">
                        <strong>$${registro.total.toLocaleString()}</strong><br>
                        <small>${desglose}</small><br>
                        <small style="color: #888;">${registro.timestamp}</small>
                    </div>
                `;
            }
            historialList.innerHTML = html;
        }

        function limpiarTodo() {
            if (confirm('¬øSeguro que quieres limpiar todo el historial?')) {
                deteccionesActuales = {};
                totalActual = 0;
                historial = [];
                
                localStorage.removeItem('historial_billetes');
                
                actualizarDisplay();
                actualizarHistorialUI();
                
                document.getElementById('status').textContent = 'üóëÔ∏è Todo limpiado';
                setTimeout(() => {
                    if (deteccionActiva) {
                        document.getElementById('status').textContent = '‚úÖ C√°mara activa - Detectando...';
                    } else {
                        document.getElementById('status').textContent = 'Presiona iniciar para comenzar';
                    }
                }, 2000);
            }
        }

        // Limpiar al cerrar
        window.onbeforeunload = function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        };
    </script>
</body>
</html>