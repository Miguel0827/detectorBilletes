<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detector Billetes Pro</title>
<style>
/* Mantengo tu CSS, lo puedes usar igual */
body { font-family: Arial; background:#111; color:#fff; margin:0; padding:0;}
.container { padding:10px; max-width:480px; margin:auto;}
.camera-container { position:relative; width:100%; }
#video { width:100%; height:auto; border-radius:12px; }
#canvas { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
button { padding:10px; margin:5px; border-radius:8px; cursor:pointer;}
</style>
</head>
<body>
<div class="container">
    <h1>üíµ Detector de Billetes Pro</h1>
    <div id="status">Presiona iniciar</div>
    <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    <h2 id="total">$0</h2>
    <button id="btnStart" onclick="iniciarCamara()">üé• INICIAR</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let session = null;
let stream = null;
let deteccionActiva = false;
let deteccionInterval = 1500;
let procesando = false;

const INPUT_SIZE = 320;
const CONF_THRESHOLD = 0.6;
const IOU_THRESHOLD = 0.5;

const VALORES = {"100":100,"200":200,"500":500,"1000":1000,"2000":2000,"5000":5000,"10000":10000,"20000":20000,"50000":50000,"100000":100000};
const CLASS_NAMES = Object.keys(VALORES);
let deteccionesActuales = {};
let totalActual = 0;

async function cargarModelo() {
    document.getElementById('status').textContent = 'Cargando modelo...';
    try {
        session = await ort.InferenceSession.create('models/best.onnx');
        document.getElementById('status').textContent = '‚úÖ Modelo listo';
    } catch(e){
        console.error(e);
        document.getElementById('status').textContent = '‚ùå Error cargando modelo';
    }
}

async function iniciarCamara() {
    if (!session) { alert('‚ö†Ô∏è Modelo no cargado'); return; }
    try {
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            deteccionActiva = true;
            document.getElementById('status').textContent = '‚úÖ Detectando';
            detectarLoop();
        };
    } catch(e){ console.error(e); document.getElementById('status').textContent='‚ùå Error c√°mara'; }
}

function preprocesarImagen() {
    const temp = document.createElement('canvas');
    temp.width = INPUT_SIZE; temp.height = INPUT_SIZE;
    const tctx = temp.getContext('2d');
    tctx.drawImage(video,0,0,INPUT_SIZE,INPUT_SIZE);
    const data = tctx.getImageData(0,0,INPUT_SIZE,INPUT_SIZE).data;
    const input = new Float32Array(3*INPUT_SIZE*INPUT_SIZE);
    for(let i=0;i<INPUT_SIZE*INPUT_SIZE;i++){
        input[i] = data[i*4]/255.0;
        input[i+INPUT_SIZE*INPUT_SIZE] = data[i*4+1]/255.0;
        input[i+2*INPUT_SIZE*INPUT_SIZE] = data[i*4+2]/255.0;
    }
    return new ort.Tensor('float32', input, [1,3,INPUT_SIZE,INPUT_SIZE]);
}

function postprocesarResultados(outputData, width, height){
    const detecciones=[];
    const numClasses=CLASS_NAMES.length;
    const numBoxes=outputData.length/(numClasses+4);
    for(let i=0;i<numBoxes;i++){
        const x=outputData[i], y=outputData[numBoxes+i], w=outputData[2*numBoxes+i], h=outputData[3*numBoxes+i];
        let maxScore=0, maxClass=0;
        for(let c=0;c<numClasses;c++){
            const s=outputData[4*numBoxes+c*numBoxes+i];
            if(s>maxScore){ maxScore=s; maxClass=c; }
        }
        if(maxScore>CONF_THRESHOLD){
            const x1=(x-w/2)*width/INPUT_SIZE;
            const y1=(y-h/2)*height/INPUT_SIZE;
            const x2=(x+w/2)*width/INPUT_SIZE;
            const y2=(y+h/2)*height/INPUT_SIZE;
            detecciones.push({class:CLASS_NAMES[maxClass],conf:maxScore,bbox:[x1,y1,x2,y2]});
        }
    }
    return detecciones;
}

function nonMaxSuppression(dets,iouT){
    dets.sort((a,b)=>b.conf-a.conf);
    const res=[], suppressed=new Array(dets.length).fill(false);
    for(let i=0;i<dets.length;i++){
        if(suppressed[i]) continue;
        res.push(dets[i]);
        for(let j=i+1;j<dets.length;j++){
            if(suppressed[j]) continue;
            if(dets[i].class===dets[j].class){
                const iou=calcularIoU(dets[i].bbox,dets[j].bbox);
                if(iou>iouT) suppressed[j]=true;
            }
        }
    }
    return res;
}

function calcularIoU(b1,b2){
    const xi1=Math.max(b1[0],b2[0]), yi1=Math.max(b1[1],b2[1]);
    const xi2=Math.min(b1[2],b2[2]), yi2=Math.min(b1[3],b2[3]);
    const inter=Math.max(0,xi2-xi1)*Math.max(0,yi2-yi1);
    const union=(b1[2]-b1[0])*(b1[3]-b1[1])+(b2[2]-b2[0])*(b2[3]-b2[1])-inter;
    return union>0?inter/union:0;
}

function dibujarDetecciones(dets){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='#00ff88'; ctx.lineWidth=2; ctx.font='bold 14px Arial';
    for(const det of dets){
        const [x1,y1,x2,y2]=det.bbox;
        ctx.strokeRect(x1,y1,x2-x1,y2-y1);
        const label=`${det.class} ${(det.conf*100).toFixed(0)}%`;
        const w=ctx.measureText(label).width;
        ctx.fillStyle='#00ff88'; ctx.fillRect(x1,y1-20,w+8,20);
        ctx.fillStyle='#000'; ctx.fillText(label,x1+4,y1-4);
    }
}

function actualizarDisplay(){
    totalActual=0; for(let [b,c] of Object.entries(deteccionesActuales)) totalActual+=VALORES[b]*c;
    document.getElementById('total').textContent=`$${totalActual.toLocaleString()}`;
}

async function detectarLoop(){
    if(!deteccionActiva || procesando) return;
    procesando=true;
    try{
        const input=preprocesarImagen();
        const feeds={}; feeds[session.inputNames[0]]=input;
        const out=await session.run(feeds);
        const dets=nonMaxSuppression(postprocesarResultados(out[session.outputNames[0]].data,canvas.width,canvas.height),IOU_THRESHOLD);
        deteccionesActuales={};
        dets.forEach(d=>deteccionesActuales[d.class]=(deteccionesActuales[d.class]||0)+1);
        dibujarDetecciones(dets);
        actualizarDisplay();
    }catch(e){ console.error(e);}
    procesando=false;
    setTimeout(detectarLoop,deteccionInterval);
}

cargarModelo();
</script>
</body>
</html>
